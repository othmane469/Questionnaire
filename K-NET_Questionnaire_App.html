<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire K-NET - D√©couverte Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-900);
            background: var(--gray-50);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .top-bar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .top-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .progress-bar {
            flex: 1;
            max-width: 400px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-outline:hover {
            background: var(--gray-50);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .section-nav {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .section-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            transform: translateY(-2px);
        }

        .section-card.completed {
            border-left: 4px solid var(--success);
        }

        .section-card.in-progress {
            border-left: 4px solid var(--warning);
        }

        .section-card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .section-card p {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .section-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-default {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .question-section {
            display: none;
        }

        .question-section.active {
            display: block;
        }

        .section-header {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
        }

        .section-header h2 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .section-header p {
            color: var(--gray-600);
        }

        .question-block {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
        }

        .question-block h4 {
            color: var(--gray-900);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .question-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        input[type="radio"] {
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--gray-300);
        }

        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
        }

        .notes {
            background: #fffbeb0;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #92400e;
        }

        .draft-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            padding: 1rem 2rem;
            margin: 1rem auto;
            max-width: 1200px;
            border-radius: 8px;
            display: none;
        }

        .draft-notice.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .draft-notice-text {
            flex: 1;
        }

        .draft-notice-text strong {
            color: #92400e;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-content h3 {
            margin-bottom: 1rem;
            color: var(--gray-900);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .top-bar-content {
                flex-direction: column;
            }

            .section-nav {
                grid-template-columns: 1fr;
            }

            .main-content,
            .header-content {
                padding: 0 1rem;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        .hidden {
            display: none !important;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            color: var(--gray-600);
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: var(--primary);
        }

        .breadcrumb-separator {
            color: var(--gray-400);
        }

        .breadcrumb-current {
            color: var(--gray-900);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>Questionnaire de D√©couverte K-NET</h1>
            <p>D√©finition de l'architecture technique et des contraintes pour K-NET</p>
        </div>
    </div>

    <!-- Draft Notice -->
    <div id="draftNotice" class="draft-notice">
        <div class="draft-notice-text">
            <strong>üíæ Brouillon Restaur√©</strong>
            Vos r√©ponses ont √©t√© restaur√©es depuis une sauvegarde pr√©c√©dente.
        </div>
        <button class="btn btn-danger" onclick="discardDraft()">Ignorer le Brouillon</button>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="progress-info">
                <span class="progress-text" id="progressText">0% compl√©t√©</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-success" onclick="saveDraft()">
                    üíæ Sauvegarder
                </button>
                <button class="btn btn-primary" onclick="showDownloadModal()">
                    üì• T√©l√©charger
                </button>
                <button class="btn btn-outline" onclick="showUploadModal()">
                    üì§ Importer
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Home View -->
        <div id="homeView">
            <div class="section-nav" id="sectionNav">
                <!-- Sections will be rendered here -->
            </div>
        </div>

        <!-- Question View -->
        <div id="questionView" class="question-section">
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item" onclick="goHome()">Accueil</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-current" id="currentSectionTitle"></span>
            </div>

            <div class="section-header">
                <h2 id="sectionTitle"></h2>
                <p id="sectionDescription"></p>
            </div>

            <div id="questionsContainer">
                <!-- Questions will be rendered here -->
            </div>

            <div class="actions" style="margin-top: 2rem; justify-content: center;">
                <button class="btn btn-outline" onclick="goHome()">‚Üê Retour</button>
                <button class="btn btn-success" onclick="saveAndContinue()">Sauvegarder et Continuer</button>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <h3>üì• T√©l√©charger les R√©ponses</h3>
            <p style="color: var(--gray-600); margin-bottom: 1rem;">Choisissez le format de t√©l√©chargement :</p>
            <div class="form-group">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="downloadJSON()">
                    üìÑ T√©l√©charger en JSON (pour import ult√©rieur)
                </button>
                <button class="btn btn-outline" style="width: 100%; margin-bottom: 0.5rem;" onclick="downloadMarkdown()">
                    üìù T√©l√©charger en Markdown (pour lecture)
                </button>
                <button class="btn btn-outline" style="width: 100%;" onclick="downloadTxt()">
                    üìÉ T√©l√©charger en TXT (simple)
                </button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModals()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h3>üì§ Importer des R√©ponses</h3>
            <p style="color: var(--gray-600); margin-bottom: 1rem;">Importez un fichier JSON pr√©c√©demment t√©l√©charg√© :</p>
            <div class="form-group">
                <input type="file" id="fileInput" accept=".json" onchange="handleFileUpload(event)">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModals()">Annuler</button>
                <button class="btn btn-primary" onclick="confirmUpload()">Importer</button>
            </div>
        </div>
    </div>

    <script>
        // Questionnaire Data Structure
        const questionnaireData = {
            meta: {
                title: "Questionnaire de D√©couverte de l'Architecture K-NET",
                version: "1.1",
                dateStarted: "",
                lastUpdated: "",
                status: "not_started"
            },
            sections: {
                A: {
                    id: "A",
                    title: "Contexte M√©tier & Clients",
                    description: "Comprend les utilisateurs cibles, le mod√®le de revenus, et la propri√©t√© des donn√©es.",
                    questions: [
                        {
                            id: "A1_users",
                            type: "textarea",
                            label: "Qui sont les utilisateurs PRINCIPAUX de K-NET par ordre de priorit√© ?",
                            placeholder: "Priorit√© 1: [ex., √âquipe op√©rations interne KardaTech]\nPriorit√© 2: [ex., Installateurs partenaires]\nPriorit√© 3: [ex., Clients finaux]\n...",
                            multiline: true
                        },
                        {
                            id: "A1_pain_points",
                            type: "textarea",
                            label: "Pour chaque utilisateur principal, quel est son point de douleur quotidien #1 que K-NET r√©sout ?",
                            placeholder: "Priorit√© 1: [Description]\nPriorit√© 2: [Description]\n...",
                            multiline: true
                        },
                        {
                            id: "A2_revenue",
                            type: "radio",
                            label: "Comment g√©n√©rez-vous des revenus avec K-NET ?",
                            options: ["Frais de licence unique", "Abonnement mensuel SaaS", "Frais par transaction", "% des projets financ√©s", "Autre"]
                        },
                        {
                            id: "A2_revenue_detail",
                            type: "textarea",
                            label: "D√©tails du mod√®le de revenus (principal, secondaires, structure tarifaire)",
                            placeholder: "Mod√®le Principal: ...\nSources Secondaires: ...\nStructure Tarifaire: ...",
                            multiline: true
                        },
                        {
                            id: "A3_data_ownership",
                            type: "radio",
                            label: "Qui poss√®de les donn√©es dans K-NET lorsque sous licence √† un installateur ?",
                            options: ["KardaTech poss√®de tout", "Chaque installateur poss√®de ses donn√©es", "Le client poss√®de ses donn√©es", "Hybride"]
                        },
                        {
                            id: "A3_data_usage",
                            type: "checkbox",
                            label: "KardaTech peut-elle utiliser les donn√©es agr√©g√©es pour :",
                            options: ["Benchmarking", "Am√©lioration produit", "Vente d'insights", "Marketing"]
                        }
                    ]
                },
                B: {
                    id: "B",
                    title: "Contraintes Techniques",
                    description: "Exigences temps r√©el, capacit√©s de contr√¥le, et sc√©narios hors ligne.",
                    questions: [
                        {
                            id: "B1_realtime",
                            type: "table",
                            label: "Que signifie 'temps r√©el' pour K-NET dans diff√©rents sc√©narios ?",
                            columns: ["Sc√©nario", "Tol√©rance Latence", "Est Critique ?", "Impact si Non Respect√©"],
                            rows: [
                                ["Actualisation tableau de bord", "", "", ""],
                                ["D√©tection panne onduleur", "", "", ""],
                                ["Calcul facturation", "", "", ""],
                                ["Rapports bancaires", "", "", ""],
                                ["Signaux r√©seau V2G", "", "", ""]
                            ]
                        },
                        {
                            id: "B2_control",
                            type: "table",
                            label: "Capacit√©s de K-NET (lire vs contr√¥ler)",
                            columns: ["Capacit√©", "Horizon", "Priorit√©"],
                            rows: [
                                ["Lire donn√©es production", "", ""],
                                ["Envoyer commandes limitation", "", ""],
                                ["Dispatcher batteries", "", ""],
                                ["Contr√¥ler bornes VE", "", ""],
                                ["D√©connecter actifs distance", "", ""]
                            ]
                        },
                        {
                            id: "B2_risk",
                            type: "textarea",
                            label: "Que se passe-t-il si K-NET envoie une mauvaise commande ? (responsabilit√©, s√©curit√©, etc.)",
                            placeholder: "D√©crivez les risques et cons√©quences...",
                            multiline: true
                        },
                        {
                            id: "B3_offline",
                            type: "textarea",
                            label: "Que se passe-t-il lorsqu'un site perd sa connectivit√© internet ?",
                            placeholder: "Dur√©e hors ligne acceptable : ...\nTampon local : ...\nCalcul de bord : ...\nFacturation hors ligne : ...",
                            multiline: true
                        }
                    ]
                },
                C: {
                    id: "C",
                    title: "Paysage Appareils & Int√©grations",
                    description: "√âcosyst√®me mat√©riel et int√©grations syst√®mes externes.",
                    questions: [
                        {
                            id: "C1_inverters",
                            type: "textarea",
                            label: "Marques/Mod√®les d'onduleurs au Maroc et protocoles/APIs",
                            placeholder: "Marques/Mod√®les:\n- Huawei SUN2000\n- ...\n\nProtocoles:\n- Modbus RTU\n- ...\n",
                            multiline: true
                        },
                        {
                            id: "C1_meters",
                            type: "textarea",
                            label: "Compteurs intelligents - Marques/Mod√®les et protocoles",
                            placeholder: "Marques/Mod√®les:\n- ...\n\nProtocoles:\n- ...\n",
                            multiline: true
                        },
                        {
                            id: "C1_connectivity",
                            type: "checkbox",
                            label: "Options de connectivit√© :",
                            options: ["RS485 filaire", "Ethernet", "WiFi", "4G/LTE", "LoRaWAN", "Autre"]
                        },
                        {
                            id: "C2_future_devices",
                            type: "textarea",
                            label: "Appareils attendus dans 1-2 ans (batteries, bornes VE, pompes √† chaleur, etc.)",
                            placeholder: "Batteries: ...\nBornes VE: ...\n...",
                            multiline: true
                        },
                        {
                            id: "C2_banking",
                            type: "textarea",
                            label: "Int√©grations bancaires (banques cibles, Green Invest, etc.)",
                            placeholder: "Banques Cibles:\n- ...\n\nPlateforme Green Invest: ...\n",
                            multiline: true
                        },
                        {
                            id: "C2_payment",
                            type: "textarea",
                            label: "Syst√®mes de paiement (passerelles, pr√©l√®vement, APIs)",
                            placeholder: "Passerelles: ...\nPr√©l√®vement: ...\nAPIs: ...\n",
                            multiline: true
                        },
                        {
                            id: "C2_utility",
                            type: "textarea",
                            label: "Int√©grations utilitaires/gouvernementales (ONEE, ANRE, AMEE)",
                            placeholder: "ONEE: ...\nANRE: ...\nAMEE: ...\n",
                            multiline: true
                        },
                        {
                            id: "C2_esg",
                            type: "textarea",
                            label: "Syst√®mes carbone/ESG (registres, plateformes de rapport, MRV)",
                            placeholder: "Registres Carbone: ...\nESG Reporting: ...\nMRV: ...\n",
                            multiline: true
                        }
                    ]
                },
                D: {
                    id: "D",
                    title: "Mod√®le Financier & Risque",
                    description: "Responsabilit√©, marges d'erreur, complexit√© de facturation, conformit√©.",
                    questions: [
                        {
                            id: "D1_liability",
                            type: "textarea",
                            label: "Qui absorbe la diff√©rence si K-NET se trompe ? Marge d'erreur acceptable ? R√©solution des litiges ?",
                            placeholder: "Responsabilit√©: ...\nMarge erreur: ...\nLitiges: ...\nAssurance: ...\n",
                            multiline: true
                        },
                        {
                            id: "D1_scenarios",
                            type: "textarea",
                            label: "Sc√©narios d'erreur (sous-rapport 10%, sur-rapport 10%, hors ligne 48h)",
                            placeholder: "Sc√©nario 1: ...\nSc√©nario 2: ...\nSc√©nario 3: ...\n",
                            multiline: true
                        },
                        {
                            id: "D2_pricing",
                            type: "textarea",
                            label: "Complexit√© tarifaire (tarif plat, paliers, temps d'usage, garanties performance)",
                            placeholder: "Tarif plat: ...\nPaliers: ...\nTemps d'usage: ...\nGaranties: ...\n",
                            multiline: true
                        },
                        {
                            id: "D2_advanced_pricing",
                            type: "textarea",
                            label: "Fonctions tarifaires avanc√©es (inflation, change, minimums, saisonnier)",
                            placeholder: "Indexation inflation: ...\nChange: ...\nMinimums: ...\nSaisonnier: ...\n",
                            multiline: true
                        },
                        {
                            id: "D2_formula",
                            type: "textarea",
                            label: "Collez votre formule tarifaire contractuelle la PLUS complexe ici",
                            placeholder: "Incluez toutes variables, conditions, cas limites...",
                            multiline: true
                        },
                        {
                            id: "D3_residency",
                            type: "textarea",
                            label: "R√©sidence des donn√©es (doivent √™tre stock√©es au Maroc ? certifications ?)",
                            placeholder: "Stockage Maroc: ...\nCertifications: ...\n",
                            multiline: true
                        },
                        {
                            id: "D3_audit",
                            type: "textarea",
                            label: "Tra√ßabilit√© d'audit requise et p√©riode de r√©tention",
                            placeholder: "Tra√ßabilit√©: ...\nR√©tention: ...\n",
                            multiline: true
                        },
                        {
                            id: "D3_reporting",
                            type: "textarea",
                            label: "Exigences de rapport (fr√©quence, donn√©es, destinataires)",
                            placeholder: "Fr√©quence: ...\nDonn√©es: ...\nDestinataires: ...\n",
                            multiline: true
                        },
                        {
                            id: "D3_banking_reg",
                            type: "textarea",
                            label: "R√©glementations bancaires (processeur paiement, licences, AML/KYC)",
                            placeholder: "Processeur paiement: ...\nLicences: ...\nAML/KYC: ...\n",
                            multiline: true
                        }
                    ]
                },
                E: {
                    id: "E",
                    title: "√âchelle & Performance",
                    description: "Trajectoire de croissance et r√©tention des donn√©es.",
                    questions: [
                        {
                            id: "E1_growth",
                            type: "table",
                            label: "Objectifs de croissance r√©alistes (Ann√©e 1, 2, 3, 5)",
                            columns: ["M√©trique", "Ann√©e 1", "Ann√©e 2", "Ann√©e 3", "Ann√©e 5"],
                            rows: [
                                ["Nombre d'Actifs (sites)", "", "", "", ""],
                                ["Capacit√© Install√©e Totale (MW)", "", "", "", ""],
                                ["Nombre de Clients Finaux", "", "", "", ""],
                                ["Nombre d'Installateurs Partenaires", "", "", "", ""],
                                ["Points de Donn√©es Par Jour", "", "", "", ""]
                            ]
                        },
                        {
                            id: "E1_assumptions",
                            type: "textarea",
                            label: "Hypoth√®ses de croissance (qu'est-ce qui alimente ces chiffres ? acc√©l√©rateurs ? ralentisseurs ?)",
                            placeholder: "Facteurs: ...\nAcc√©l√©rateurs: ...\nRalentisseurs: ...\n",
                            multiline: true
                        },
                        {
                            id: "E2_retention",
                            type: "table",
                            label: "P√©riode de r√©tention des diff√©rents types de donn√©es",
                            columns: ["Type de Donn√©e", "R√©tention", "Stockage Chaud/Ti√©/Froid", "Raison"],
                            rows: [
                                ["Lectures brutes (seconde)", "", "", ""],
                                ["Lectures brutes (minute)", "", "", ""],
                                ["Donn√©es horaires agr√©g√©es", "", "", ""],
                                ["Donn√©es quotidiennes agr√©g√©es", "", "", ""],
                                ["Dossiers financiers", "", "", ""],
                                ["Contrats documents juridiques", "", "", ""],
                                ["PII Clients", "", "", ""],
                                ["Journaux d'audit", "", "", ""],
                                ["Alertes notifications", "", "", ""]
                            ]
                        },
                        {
                            id: "E2_storage_def",
                            type: "textarea",
                            label: "D√©finitions de stockage (chaud, ti√®de, froid)",
                            placeholder: "Chaud: ...\nTi√®de: ...\nFroid: ...\n",
                            multiline: true
                        }
                    ]
                },
                F: {
                    id: "F",
                    title: "√âquipe & Ressources",
                    description: "√âquipe de d√©veloppement, op√©rations, budget infrastructure, d√©lais.",
                    questions: [
                        {
                            id: "F1_team",
                            type: "textarea",
                            label: "√âquipe actuelle (backend, frontend, data, devops, produit, QA)",
                            placeholder: "Backend: ...\nFrontend: ...\nData: ...\nDevOps: ...\nProduit: ...\nQA: ...\n",
                            multiline: true
                        },
                        {
                            id: "F1_expertise",
                            type: "textarea",
                            label: "Expertise technologique (connues, √† apprendre, n'utilisera pas)",
                            placeholder: "Connues: ...\n√Ä apprendre: ...\nN'utilisera pas: ...\n",
                            multiline: true
                        },
                        {
                            id: "F1_partners",
                            type: "textarea",
                            label: "Partenaires externes (offshore, agences, consultants)",
                            placeholder: "Offshore: ...\nAgences: ...\n",
                            multiline: true
                        },
                        {
                            id: "F1_hiring",
                            type: "textarea",
                            label: "Plans d'embauche (budget 12 mois, postes √† pourvoir)",
                            placeholder: "Budget: ...\nPostes:\n- ...\n",
                            multiline: true
                        },
                        {
                            id: "F2_ops",
                            type: "textarea",
                            label: "√âquipe op√©rations (DevOps/SRE, astreinte 24/7, r√©ponse incidents)",
                            placeholder: "DevOps/SRE: ...\nAstreinte: ...\nIncidents 3h: ...\n",
                            multiline: true
                        },
                        {
                            id: "F2_support",
                            type: "textarea",
                            label: "Support client (qui, comment, temps de r√©ponse)",
                            placeholder: "Qui: ...\nCanal: ...\nTemps r√©ponse: ...\n",
                            multiline: true
                        },
                        {
                            id: "F3_budget",
                            type: "textarea",
                            label: "Budget infrastructure (mensuel ann√©e 1, croissance, contraintes)",
                            placeholder: "Mensuel: ...\nCroissance: ...\nContraintes cloud/r√©gion/verrouillage/open-source: ...\n",
                            multiline: true
                        },
                        {
                            id: "F4_deadlines",
                            type: "textarea",
                            label: "D√©lais stricts (pilote, partenaire, banque, conformit√©, autres)",
                            placeholder: "Pilote: ...\nPartenaire: ...\nBanque: ...\nConformit√©: ...\nAutres: ...\n",
                            multiline: true
                        },
                        {
                            id: "F4_reality",
                            type: "textarea",
                            label: "V√©rification r√©alisme (flexibilit√© ? cons√©quences ? d√©lai PLUS critique ?)",
                            placeholder: "Flexibilit√©: ...\nCons√©quences: ...\nPlus critique: ...\n",
                            multiline: true
                        }
                    ]
                },
                G: {
                    id: "G",
                    title: "S√©curit√© & Confiance",
                    description: "Mod√®le de menace, s√©curit√© bancaire, contr√¥le d'acc√®s.",
                    questions: [
                        {
                            id: "G1_threats",
                            type: "textarea",
                            label: "Classez les menaces de 1 (plus pr√©occupant) √† 5, et √©laborez le top 3",
                            placeholder: "Classement:\n[ ] Fuite donn√©es\n[ ] Manipulation donn√©es\n...\n\nTop 3:\n#1: ...\n#2: ...\n#3: ...\n",
                            multiline: true
                        },
                        {
                            id: "G2_banking_security",
                            type: "textarea",
                            label: "Normes de s√©curit√© requises par les banques (SOC 2, p√©n√©tration, auditeurs, ISO)",
                            placeholder: "SOC 2: ...\nP√©n√©tration: ...\nAuditeurs: ...\nNorme minimum: ...\n",
                            multiline: true
                        },
                        {
                            id: "G2_integrity",
                            type: "textarea",
                            label: "Int√©grit√© des donn√©es (prouver non alt√©ration, contestation client)",
                            placeholder: "Preuve non alt√©ration: ...\nContestation: ...\n",
                            multiline: true
                        },
                        {
                            id: "G3_roles",
                            type: "textarea",
                            label: "D√©finissez chaque r√¥le (Admin KardaTech, Op√©rations, Installateur, Client, Banque, Auditeur) - peut voir/faire",
                            placeholder: "R√¥le: Admin KardaTech\nPeut voir: ...\nPeut faire: ...\n\n(r√©p√©ter pour chaque r√¥le)\n",
                            multiline: true
                        }
                    ]
                },
                H: {
                    id: "H",
                    title: "Diff√©renciation Concurrentielle",
                    description: "Capacit√©s uniques et services tiers √† acheter.",
                    questions: [
                        {
                            id: "H1_unique",
                            type: "textarea",
                            label: "Que doit faire K-NET que les produits standards ne peuvent pas ? (Pourquoi pas solaire/fintech/IoT standards)",
                            placeholder: "Monitoring solaire manque: ...\nFintech pas adapt√© car: ...\nIoT g√©n√©rique gap: ...\n\nCapacit√©s K-NET:\n1. ...\n2. ...\n",
                            multiline: true
                        },
                        {
                            id: "H2_buy",
                            type: "checkbox",
                            label: "Services tiers √† utiliser (cartographie, m√©t√©o, paiement, notifications, auth, analyses)",
                            options: [
                                "Google Maps", "Mapbox", "OpenStreetMap",
                                "OpenWeatherMap", "M√©t√©oFrance", "Local m√©t√©o",
                                "Stripe", "PayPal", "CMI", "APIs locales",
                                "SendGrid", "Twilio", "SMS local", "Push",
                                "Auth0", "Firebase", "Keycloak", "Custom",
                                "Google Analytics", "Mixpanel", "Amplitude", "Custom"
                            ]
                        },
                        {
                            id: "H2_philosophy",
                            type: "radio",
                            label: "Philosophie d'int√©gration :",
                            options: ["Acheter plut√¥t que construire (SaaS)", "Construire plut√¥t qu'acheter (interne)", "Hybride (construire c≈ìur, acheter p√©riph√©riques)"]
                        }
                    ]
                },
                I: {
                    id: "I",
                    title: "Questions Strat√©giques",
                    description: "Pourquoi K-NET gagnera ? Qu'est-ce qui pourrait causer l'√©chec ?",
                    questions: [
                        {
                            id: "I1_success",
                            type: "textarea",
                            label: "Dans 2 ans, pourquoi KardaTech aura gagn√© ? (Meilleure UX, Donn√©es pr√©cises, Confiance banques, D√©ploiement rapide, Co√ªt faible, Autre)",
                            placeholder: "Raison principale: ...\nPourquoi: ...\nExemple: ...\n",
                            multiline: true
                        },
                        {
                            id: "I2_failure",
                            type: "textarea",
                            label: "Qu'est-ce qui causerait l'√©chec de K-NET ? (5 risques avec probabilit√© et att√©nuation, signes avant-coureurs)",
                            placeholder: "Risque 1: ...\nProbabilit√©: ...\nAtt√©nuation: ...\n\n(r√©p√©ter pour 5 risques)\n\nSignes avant-coureurs: ...\nCadence: ...\n",
                            multiline: true
                        }
                    ]
                },
                J: {
                    id: "J",
                    title: "D√©finitions des Priorit√©s",
                    description: "La chose LA PLUS importante, fonctionnalit√© critique, p√©rim√®tre MVP, m√©triques succ√®s.",
                    questions: [
                        {
                            id: "J1_one_thing",
                            type: "textarea",
                            label: "Si vous ne pouviez faire UNE seule chose correctement, quelle est-elle ? (Pourquoi plus important ? Que sacrifier ?)",
                            placeholder: "La chose: ...\nPourquoi: ...\nSacrifice: ...\n",
                            multiline: true
                        },
                        {
                            id: "J1_critical",
                            type: "textarea",
                            label: "Quelle est la fonctionnalit√© qui, si manquante, rend K-NET inutile ? (Pourquoi non-n√©gociable ? Cons√©quences ?)",
                            placeholder: "Fonctionnalit√©: ...\nPourquoi: ...\nCons√©quences: ...\n",
                            multiline: true
                        },
                        {
                            id: "J2_mvp",
                            type: "textarea",
                            label: "P√©rim√®tre MVP (DOIT √™tre inclus vs peut attendre V2 vs ne sera JAMAIS construit)",
                            placeholder: "DOIT:\n1. ...\n\nV2:\n1. ...\n\nJAMAIS:\n1. ...\n",
                            multiline: true
                        },
                        {
                            id: "J3_metrics",
                            type: "textarea",
                            label: "M√©triques de succ√®s (techniques, m√©tier, financi√®res)",
                            placeholder: "Techniques:\n- Disponibilit√©: ...\n- Pr√©cision donn√©es: ...\n- Temps r√©ponse API: ...\n\nM√©tier:\n- Temps int√©gration partenaire: ...\n- Temps d√©ploiement site: ...\n\nFinanci√®res:\n- Co√ªt/site/mois: ...\n- Seuil rentabilit√©: ...\n",
                            multiline: true
                        }
                    ]
                },
                K: {
                    id: "K",
                    title: "Exp√©rience Utilisateur & Interface",
                    description: "Focus plateforme, comp√©tence utilisateur, style tableau de bord.",
                    questions: [
                        {
                            id: "K1_platforms",
                            type: "table",
                            label: "Plateforme interface principale pour chaque type d'utilisateur",
                            columns: ["Type Utilisateur", "Appareil Principal", "Secondaire", "Terrain/Distant"],
                            rows: [
                                ["Admin KardaTech", "", "", ""],
                                ["Op√©rations KardaTech", "", "", ""],
                                ["Installateur Partenaire", "", "", ""],
                                ["Techniciens Installateurs", "", "", ""],
                                ["Client Final", "", "", ""],
                                ["Banque/Investisseur", "", "", ""]
                            ]
                        },
                        {
                            id: "K1_mobile",
                            type: "textarea",
                            label: "Exigences mobiles (apps natives, web responsive, hors ligne)",
                            placeholder: "Apps natives: ...\nResponsive: ...\nHors ligne: ...\n",
                            multiline: true
                        },
                        {
                            id: "K2_proficiency",
                            type: "textarea",
                            label: "Comp√©tence technique utilisateurs (1-5 par groupe, implications UI)",
                            placeholder: "Admin KardaTech: [1-5]\n...\n\nImplications UI: ...\n",
                            multiline: true
                        },
                        {
                            id: "K2_accessibility",
                            type: "checkbox",
                            label: "Exigences d'accessibilit√© :",
                            options: ["Support lecteur √©cran", "Mode contraste √©lev√©", "Options texte agrandi", "Navigation clavier uniquement"]
                        },
                        {
                            id: "K3_dashboard_ops",
                            type: "textarea",
                            label: "Tableau de bord Op√©rations KardaTech (vue principale, densit√© information)",
                            placeholder: "Vue principale:\n- Carte sites\n- Alertes\n- Performance\n\nDensit√©: Minimal/Mod√©r√©e/Dense\n",
                            multiline: true
                        },
                        {
                            id: "K3_dashboard_customer",
                            type: "textarea",
                            label: "Tableau de bord Clients Finaux (vue principale, ton √©motionnel)",
                            placeholder: "Vue principale:\n- Production actuelle\n- √âconomies\n- Impact CO2\n\nTon: Rassurant/Data-driven/Ludifi√©/Pro\n",
                            multiline: true
                        }
                    ]
                },
                L: {
                    id: "L",
                    title: "Rapports & Analyses",
                    description: "Rapports standards, exports personnalis√©s, analyses pr√©dictives.",
                    questions: [
                        {
                            id: "L1_standard",
                            type: "table",
                            label: "Rapports standards requis (nom, qui, fr√©quence, format, donn√©es cl√©s)",
                            columns: ["Nom Rapport", "Qui", "Fr√©quence", "Format", "Donn√©es Cl√©s"],
                            rows: [
                                ["", "", "", "", ""],
                                ["", "", "", "", ""],
                                ["", "", "", "", ""]
                            ]
                        },
                        {
                            id: "L1_delivery",
                            type: "textarea",
                            label: "Distribution des rapports (comment livr√©s ? personnalisation ?)",
                            placeholder: "Livraison: ...\nPersonnalisation: ...\n",
                            multiline: true
                        },
                        {
                            id: "L2_export",
                            type: "textarea",
                            label: "Flexibilit√© export (donn√©es brutes, tableaux personnalis√©s, planification, partage)",
                            placeholder: "Export brutes: ...\nCustom dashboards: ...\nPlanification: ...\nPartage: ...\n",
                            multiline: true
                        },
                        {
                            id: "L2_limits",
                            type: "textarea",
                            label: "Limites export (quelles donn√©es ? restrictions conformit√© ?)",
                            placeholder: "Limites: ...\nRestrictions conformit√©: ...\n",
                            multiline: true
                        },
                        {
                            id: "L3_predictive",
                            type: "textarea",
                            label: "Analyses pr√©dictives (production, pannes, d√©part, revenus - horizon pr√©cision)",
                            placeholder: "Pr√©dire:\n- Production future\n- Pannes √©quipement\n...\nHorizon pr√©cision: ...\n",
                            multiline: true
                        },
                        {
                            id: "L3_benchmarking",
                            type: "textarea",
                            label: "Benchmarking et comparaison (donn√©es historiques, sites similaires, moyennes industrie, r√©gionaux - diff√©renciateur ?)",
                            placeholder: "Comparer contre:\n- Historiques\n- Similaires\n- Moyennes\n- R√©gionaux\n\nDiff√©renciateur: ...\n",
                            multiline: true
                        }
                    ]
                },
                M: {
                    id: "M",
                    title: "Formation & Int√©gration",
                    description: "Flux int√©gration utilisateurs, documentation ressources, certification.",
                    questions: [
                        {
                            id: "M1_onboarding_partner",
                            type: "textarea",
                            label: "Int√©gration Installateurs Partenaires (processus, qui forme, temps signup ‚Üí productif)",
                            placeholder: "Processus:\n1. Cr√©ation compte\n2. ...\n\nQui forme: ...\nTemps cible: ...\n",
                            multiline: true
                        },
                        {
                            id: "M1_onboarding_customer",
                            type: "textarea",
                            label: "Int√©gration Clients Finaux (qui forme, concepts cl√©s, sans formation possible ?)",
                            placeholder: "Qui forme: ...\nConcepts cl√©s: ...\nSans formation: ...\n",
                            multiline: true
                        },
                        {
                            id: "M2_resources",
                            type: "checkbox",
                            label: "Ressources d'aide disponibles :",
                            options: [
                                "Infobulles tooltips", "Boutons aide contextuels", "Tutoriel/assistant interactif",
                                "Base connaissances consultable", "Assistant chatbot/IA", "Support chat direct",
                                "Guide PDF", "Didacticiels vid√©o", "FAQ", "Forum communautaire",
                                "Support email/t√©l√©phone", "Formation personne"
                            ]
                        },
                        {
                            id: "M2_philosophy",
                            type: "textarea",
                            label: "Philosophie documentation (compl√®te vs UI intuitive)",
                            placeholder: "Philosophie: ...\n",
                            multiline: true
                        },
                        {
                            id: "M3_certification",
                            type: "textarea",
                            label: "Certification et formation avanc√©e (installateurs certifi√©s ? niveaux comp√©tence ? revenue formation ?)",
                            placeholder: "Certification requise: ...\nNiveaux: ...\nRevenue: ...\n",
                            multiline: true
                        }
                    ]
                },
                N: {
                    id: "N",
                    title: "Facteurs Environnementaux & Physiques",
                    description: "Environnement exploitation et durabilit√© mat√©rielle.",
                    questions: [
                        {
                            id: "N1_location",
                            type: "textarea",
                            label: "Consid√©rations emplacement (o√π d√©ploy√© ? temp√©ratures ? dangers ?)",
                            placeholder: "Lieu d√©ploiement:\n- ...\nTemp√©ratures: ...\nDangers: ...\n",
                            multiline: true
                        },
                        {
                            id: "N1_power",
                            type: "textarea",
                            label: "Consid√©rations alimentation (perte courant, dur√©e batterie secours)",
                            placeholder: "Perte courant: ...\nDur√©e batterie: ...\n",
                            multiline: true
                        },
                        {
                            id: "N2_durability",
                            type: "textarea",
                            label: "Exigences fiabilit√© mat√©rielle (dur√©e vie, maintenance physique, pannes, diagnostics distants)",
                            placeholder: "Dur√©e vie: ...\nMaintenance physique: ...\nPannes: ...\nDiagnostics distants: ...\n",
                            multiline: true
                        }
                    ]
                },
                O: {
                    id: "O",
                    title: "Gestion Cycle de Vie Client",
                    description: "Int√©gration sites, renouvellements, d√©sint√©gration, transferts.",
                    questions: [
                        {
                            id: "O1_activation",
                            type: "textarea",
                            label: "Activation nouveaux sites (√©tapes, qui fait quoi, dur√©e, activation en masse)",
                            placeholder: "√âtapes:\n1. Installation mat√©rielle\n2. ...\n\nQui: ...\nDur√©e: ...\nMasse: ...\n",
                            multiline: true
                        },
                        {
                            id: "O2_renewal",
                            type: "textarea",
                            label: "Renouvellements et mises √† niveau (dur√©e contrat, processus, renouvellement, changements mi-contrat)",
                            placeholder: "Dur√©e contrat: ...\nProcessus: ...\nAu renouvellement: ...\nMi-contrat: ...\n",
                            multiline: true
                        },
                        {
                            id: "O3_offboarding",
                            type: "textarea",
                            label: "D√©sint√©gration et remise donn√©es (quoi gard√© ? format ? d√©commissionnement ? frais ?)",
                            placeholder: "Donn√©es conserv√©es: ...\nFormat remise: ...\nD√©commissionnement: ...\nFrais: ...\n",
                            multiline: true
                        },
                        {
                            id: "O4_transfer",
                            type: "textarea",
                            label: "Changements et transferts compte (acquisition, changement propri√©t√© - processus, donn√©es, droits, notifications)",
                            placeholder: "Processus transfert: ...\nDonn√©es transf√©r√©es: ...\nDroits donn√©es historiques: ...\nNotifications: ...\n",
                            multiline: true
                        }
                    ]
                },
                P: {
                    id: "P",
                    title: "Tests & Assurance Qualit√©",
                    description: "Philosophie tests, cadence, validation s√©curit√©.",
                    questions: [
                        {
                            id: "P1_philosophy",
                            type: "textarea",
                            label: "Philosophie tests (importance qualit√©, types non-n√©gociables, tol√©rance bugs)",
                            placeholder: "Importance: ...\nTypes non-n√©gociables:\n- ...\nTol√©rance: ...\n",
                            multiline: true
                        },
                        {
                            id: "P2_cadence",
                            type: "textarea",
                            label: "Cadence et processus tests (quand ? qui ? r√©ponse bugs critiques ?)",
                            placeholder: "Quand: ...\nQui: ...\nBugs critiques: ...\n",
                            multiline: true
                        },
                        {
                            id: "P3_pentest",
                            type: "textarea",
                            label: "Tests de p√©n√©tration et audits s√©curit√© (fr√©quence, qui, normes, partage r√©sultats)",
                            placeholder: "Fr√©quence: ...\nQui: ...\nNormes: ...\nPartage: ...\n",
                            multiline: true
                        }
                    ]
                },
                Q: {
                    id: "Q",
                    title: "Reprise Apr√®s Sinistre & Continuit√©",
                    description: "Objectifs reprise, strat√©gie sauvegarde, plans continuit√©.",
                    questions: [
                        {
                            id: "Q1_objectives",
                            type: "textarea",
                            label: "Objectifs de reprise (RTO, RPO, d√©finition sinistre, budget indisponibilit√©)",
                            placeholder: "RTO: ...\nRPO: ...\nD√©finition sinistre: ...\nBudget indisponibilit√©: ...\n",
                            multiline: true
                        },
                        {
                            id: "Q2_backup",
                            type: "textarea",
                            label: "Strat√©gie sauvegarde (fr√©quence, stockage, r√©tention, chiffrement, restauration)",
                            placeholder: "Fr√©quence: ...\nStockage: ...\nR√©tention: ...\nChiffrement: ...\nRestauration: ...\n",
                            multiline: true
                        },
                        {
                            id: "Q3_continuity",
                            type: "textarea",
                            label: "Plans continuit√© activit√©s (qui responsable ? DC d√©truit ? staff indispo ? ransomware ? SLA client ?)",
                            placeholder: "Responsable: ...\nDC d√©truit: ...\nStaff indispo: ...\nRansomware: ...\nSLA: ...\n",
                            multiline: true
                        }
                    ]
                },
                R: {
                    id: "R",
                    title: "Localisation & Support Linguistique",
                    description: "Exigences langues et personnalisation r√©gionale.",
                    questions: [
                        {
                            id: "R1_languages",
                            type: "textarea",
                            label: "Langues support√©es (requises launch, futures, switch utilisateur, RTL arabe)",
                            placeholder: "Requises: ...\nFutures: ...\nSwitch: ...\nRTL: ...\n",
                            multiline: true
                        },
                        {
                            id: "R2_regional",
                            type: "textarea",
                            label: "Personnalisation r√©gionale (date/heure, nombre/devise, unit√©s, culturel, r√©glementaire)",
                            placeholder: "Date/heure: ...\nNombre/devise: ...\nUnit√©s: ...\nCulturel: ...\nR√©glementaire: ...\n",
                            multiline: true
                        }
                    ]
                },
                S: {
                    id: "S",
                    title: "Acc√®s D√©veloppeurs Tiers",
                    description: "Disponibilit√© API, capacit√©s restrictions, documentation support.",
                    questions: [
                        {
                            id: "S1_availability",
                            type: "textarea",
                            label: "Disponibilit√© API (publique ? qui a besoin ? revenue ?)",
                            placeholder: "Publique: ...\nQui a besoin: ...\nRevenue: ...\n",
                            multiline: true
                        },
                        {
                            id: "S2_capabilities",
                            type: "textarea",
                            label: "Capacit√©s et restrictions API (quoi ? limites d√©bit ? auth ? approbation ?)",
                            placeholder: "Capacit√©s: ...\nLimites d√©bit: ...\nAuth: ...\nApprobation: ...\n",
                            multiline: true
                        },
                        {
                            id: "S2_restrictions",
                            type: "textarea",
                            label: "Restrictions acc√®s donn√©es (brutes ? agr√©g√©es ? PII ? financi√®res ? JAMAIS disponibles ?)",
                            placeholder: "Peuvent acc√©der:\n- ...\n\nJAMAIS: ...\n",
                            multiline: true
                        },
                        {
                            id: "S3_documentation",
                            type: "textarea",
                            label: "Documentation et support API (approche ? support ? SDK ?)",
                            placeholder: "Approche: ...\nSupport: ...\nSDK: ...\n",
                            multiline: true
                        }
                    ]
                }
            }
        };

        // State
        let answers = {};
        let currentSection = null;
        let pendingFileData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderSectionNav();
            updateProgress();
            checkForDraft();
        });

        // Storage key
        const STORAGE_KEY = 'knet_questionnaire_draft';
        const AUTO_SAVE_KEY = 'knet_questionnaire_autosave';

        // Load from localStorage
        function loadFromStorage() {
            const saved = localStorage.getItem(AUTO_SAVE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    answers = data.answers || {};
                    questionnaireData.meta = data.meta || questionnaireData.meta;
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        // Check for draft on load
        function checkForDraft() {
            const hasAnswers = Object.keys(answers).length > 0;
            const notice = document.getElementById('draftNotice');
            if (hasAnswers) {
                notice.classList.add('show');
            }
        }

        // Save to localStorage
        function saveToStorage() {
            const data = {
                answers: answers,
                meta: questionnaireData.meta
            };
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
        }

        // Auto-save on input change
        function autoSave(questionId, value) {
            answers[questionId] = value;
            questionnaireData.meta.lastUpdated = new Date().toISOString();
            saveToStorage();
            updateProgress();
        }

        // Discard draft
        function discardDraft() {
            if (confirm('√ätes-vous s√ªr de vouloir ignorer le brouillon ? Toutes les r√©ponses seront supprim√©es.')) {
                answers = {};
                questionnaireData.meta.lastUpdated = '';
                saveToStorage();
                location.reload();
            }
        }

        // Render section navigation
        function renderSectionNav() {
            const container = document.getElementById('sectionNav');
            container.innerHTML = '';

            for (const [key, section] of Object.entries(questionnaireData.sections)) {
                const answeredQuestions = section.questions.filter(q => answers[q.id] && answers[q.id].trim() !== '');
                const completion = answeredQuestions.length;
                const total = section.questions.length;
                const percent = Math.round((completion / total) * 100);

                let statusClass = '';
                let badge = '';

                if (completion === 0) {
                    badge = '<span class="section-badge badge-default">Non commenc√©</span>';
                } else if (completion === total) {
                    statusClass = 'completed';
                    badge = '<span class="section-badge badge-success">‚úì Compl√©t√©</span>';
                } else {
                    statusClass = 'in-progress';
                    badge = `<span class="section-badge badge-warning">${percent}%</span>`;
                }

                const card = document.createElement('div');
                card.className = `section-card ${statusClass}`;
                card.onclick = () => openSection(key);
                card.innerHTML = `
                    <h3>${section.id}. ${section.title}</h3>
                    <p>${section.description}</p>
                    ${badge}
                `;
                container.appendChild(card);
            }
        }

        // Open section
        function openSection(sectionId) {
            currentSection = sectionId;
            const section = questionnaireData.sections[sectionId];

            document.getElementById('homeView').style.display = 'none';
            document.getElementById('questionView').classList.add('active');
            document.getElementById('currentSectionTitle').textContent = `${section.id}. ${section.title}`;
            document.getElementById('sectionTitle').textContent = `${section.id}. ${section.title}`;
            document.getElementById('sectionDescription').textContent = section.description;

            renderQuestions(section.questions);
            window.scrollTo(0, 0);
        }

        // Render questions
        function renderQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const block = document.createElement('div');
                block.className = 'question-block';

                const label = document.createElement('label');
                label.className = 'question-label';
                label.textContent = `${index + 1}. ${q.label}`;
                block.appendChild(label);

                const savedValue = answers[q.id] || '';

                if (q.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.placeholder = q.placeholder || '';
                    textarea.value = savedValue;
                    textarea.oninput = (e) => autoSave(q.id, e.target.value);
                    block.appendChild(textarea);
                } else if (q.type === 'radio') {
                    const group = document.createElement('div');
                    group.className = 'radio-group';
                    q.options.forEach(opt => {
                        const item = document.createElement('label');
                        item.className = 'radio-item';
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = q.id;
                        radio.value = opt;
                        radio.checked = savedValue === opt;
                        radio.onchange = () => autoSave(q.id, opt);
                        item.appendChild(radio);
                        item.appendChild(document.createTextNode(opt));
                        group.appendChild(item);
                    });
                    block.appendChild(group);
                } else if (q.type === 'checkbox') {
                    const group = document.createElement('div');
                    group.className = 'checkbox-group';
                    const savedArray = Array.isArray(savedValue) ? savedValue : [];
                    q.options.forEach(opt => {
                        const item = document.createElement('label');
                        item.className = 'checkbox-item';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = savedArray.includes(opt);
                        checkbox.onchange = () => {
                            let newArray = [...savedArray];
                            if (checkbox.checked) {
                                newArray.push(opt);
                            } else {
                                newArray = newArray.filter(v => v !== opt);
                            }
                            autoSave(q.id, newArray);
                        };
                        item.appendChild(checkbox);
                        item.appendChild(document.createTextNode(opt));
                        group.appendChild(item);
                    });
                    block.appendChild(group);
                } else if (q.type === 'table') {
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const headRow = document.createElement('tr');
                    q.columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        headRow.appendChild(th);
                    });
                    thead.appendChild(headRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    const savedTable = Array.isArray(savedValue) ? savedValue : q.rows.map(() => []);

                    q.rows.forEach((row, rowIndex) => {
                        const tr = document.createElement('tr');
                        row.forEach((cell, cellIndex) => {
                            const td = document.createElement('td');
                            if (rowIndex === 0 && cellIndex === 0) {
                                td.textContent = cell;
                            } else {
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.value = savedTable[rowIndex]?.[cellIndex] || '';
                                input.oninput = (e) => {
                                    const newTable = [...savedTable];
                                    if (!newTable[rowIndex]) newTable[rowIndex] = [];
                                    newTable[rowIndex][cellIndex] = e.target.value;
                                    autoSave(q.id, newTable);
                                };
                                td.appendChild(input);
                            }
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    block.appendChild(table);
                }

                container.appendChild(block);
            });
        }

        // Go home
        function goHome() {
            currentSection = null;
            document.getElementById('homeView').style.display = 'block';
            document.getElementById('questionView').classList.remove('active');
            renderSectionNav();
            updateProgress();
        }

        // Update progress
        function updateProgress() {
            let totalQuestions = 0;
            let answeredQuestions = 0;

            for (const section of Object.values(questionnaireData.sections)) {
                totalQuestions += section.questions.length;
                answeredQuestions += section.questions.filter(q => {
                    const val = answers[q.id];
                    if (Array.isArray(val)) return val.length > 0;
                    return val && val.trim() !== '';
                }).length;
            }

            const percent = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
            document.getElementById('progressText').textContent = `${percent}% compl√©t√©`;
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        // Save draft button
        function saveDraft() {
            saveToStorage();
            alert('‚úì Brouillon sauvegard√© avec succ√®s !');
        }

        // Save and continue
        function saveAndContinue() {
            saveDraft();
            goHome();
        }

        // Download modal
        function showDownloadModal() {
            document.getElementById('downloadModal').classList.add('show');
        }

        // Upload modal
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
        }

        // Close modals
        function closeModals() {
            document.getElementById('downloadModal').classList.remove('show');
            document.getElementById('uploadModal').classList.remove('show');
        }

        // Download as JSON
        function downloadJSON() {
            const data = {
                meta: questionnaireData.meta,
                answers: answers
            };
            downloadFile(JSON.stringify(data, null, 2), 'knet-questionnaire-reponses.json', 'application/json');
            closeModals();
        }

        // Download as Markdown
        function downloadMarkdown() {
            let md = `# Questionnaire K-NET - R√©ponses\n\n`;
            md += `**Date:** ${new Date().toLocaleDateString('fr-FR')}\n`;
            md += `**Version:** ${questionnaireData.meta.version}\n\n---\n\n`;

            for (const [key, section] of Object.entries(questionnaireData.sections)) {
                md += `## ${section.id}. ${section.title}\n\n`;
                md += `${section.description}\n\n`;

                section.questions.forEach((q, idx) => {
                    md += `### Question ${idx + 1}\n\n`;
                    md += `${q.label}\n\n**R√©ponse:**\n`;
                    const val = answers[q.id];
                    if (Array.isArray(val)) {
                        if (val.length > 0) {
                            val.forEach(v => md += `- ${v}\n`);
                        } else {
                            md += `_Non r√©pondu_\n`;
                        }
                    } else if (val && val.trim()) {
                        md += `${val}\n`;
                    } else {
                        md += `_Non r√©pondu_\n`;
                    }
                    md += '\n---\n\n';
                });
            }

            downloadFile(md, 'knet-questionnaire-reponses.md', 'text/markdown');
            closeModals();
        }

        // Download as TXT
        function downloadTxt() {
            let txt = `QUESTIONNAIRE K-NET - REPONSES\n${'='.repeat(50)}\n\n`;
            txt += `Date: ${new Date().toLocaleDateString('fr-FR')}\n`;
            txt += `Version: ${questionnaireData.meta.version}\n\n`;

            for (const [key, section] of Object.entries(questionnaireData.sections)) {
                txt += `\n${'='.repeat(50)}\n`;
                txt += `${section.id}. ${section.title}\n`;
                txt += `${'='.repeat(50)}\n\n`;

                section.questions.forEach((q, idx) => {
                    txt += `\n[Question ${idx + 1}]\n${q.label}\n`;
                    txt += `[R√©ponse]:\n`;
                    const val = answers[q.id];
                    if (Array.isArray(val)) {
                        if (val.length > 0) {
                            val.forEach(v => txt += `  - ${v}\n`);
                        } else {
                            txt += `  (Non r√©pondu)\n`;
                        }
                    } else if (val && val.trim()) {
                        txt += `${val}\n`;
                    } else {
                        txt += `  (Non r√©pondu)\n`;
                    }
                });
            }

            downloadFile(txt, 'knet-questionnaire-reponses.txt', 'text/plain');
            closeModals();
        }

        // Download file helper
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    pendingFileData = JSON.parse(e.target.result);
                    if (pendingFileData.answers) {
                        alert('Fichier charg√© avec succ√®s ! Cliquez sur "Importer" pour confirmer.');
                    }
                } catch (err) {
                    alert('Erreur de lecture du fichier JSON. V√©rifiez le format.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // Confirm upload
        function confirmUpload() {
            if (!pendingFileData) {
                alert('Veuillez s√©lectionner un fichier d\'abord.');
                return;
            }

            if (confirm('Importer les r√©ponses ? Cela remplacera vos r√©ponses actuelles pour les questions import√©es.')) {
                answers = { ...answers, ...pendingFileData.answers };
                if (pendingFileData.meta) {
                    questionnaireData.meta = { ...questionnaireData.meta, ...pendingFileData.meta };
                }
                saveToStorage();
                closeModals();
                renderSectionNav();
                updateProgress();
                alert('‚úì Import r√©ussi !');
                pendingFileData = null;
                document.getElementById('fileInput').value = '';
            }
        }

        // Click outside modal to close
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                closeModals();
            }
        };
    </script>
</body>
</html>
